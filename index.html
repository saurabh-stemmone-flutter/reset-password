<!doctype html>
<html lang="en-US">

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>Reset Password Email Template</title>
    <meta name="description" content="Reset Password Email Template.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style type="text/css">
        a:hover {
            text-decoration: underline !important;
        }
    </style>
    <script>
        const resetPassword = async () => {

            await AuthHandler.handleVerifyEmail()
        }
        const AuthHandler = {
            init: props => {
                AuthHandler.conf = props
                AuthHandler.bindMode()
            },
            bindMode: () => {
                switch (AuthHandler.conf.mode) {
                    case 'resetPassword':
                        AuthHandler.setModeTitle('Password Reset')

                        if (!AuthHandler.validateRequiredAuthParams()) {
                            // AuthHandler.displayErrorMessage(AuthHandler.conf.defaultErrorMessage)
                            return
                        }

                        AuthHandler.handleResetPassword()
                        break;
                    case 'recoverEmail':
                        AuthHandler.setModeTitle('Email Recovery')

                        if (!AuthHandler.validateRequiredAuthParams()) {
                            // AuthHandler.displayErrorMessage(AuthHandler.conf.defaultErrorMessage)
                            return
                        }

                        AuthHandler.handleRecoverEmail()
                        break;
                    case 'verifyEmail':
                        AuthHandler.setModeTitle('Email Verification')

                        // if (!AuthHandler.validateRequiredAuthParams()) {
                        //     // AuthHandler.displayErrorMessage(AuthHandler.conf.defaultErrorMessage)
                        //     return
                        // }

                        AuthHandler.handleVerifyEmail()
                        break;
                    default:
                        // AuthHandler.displayErrorMessage(AuthHandler.conf.defaultErrorMessage)
                        break;
                }
            },
            handleResetPassword: () => {
                // AuthHandler.showLoadingSpinner()
                console.log('resetting')
                // Verify the code is valid before displaying the reset password form.
                AuthHandler.conf.verifyPasswordResetCode(AuthHandler.conf.auth, AuthHandler.conf.oobCode).then(() => {
                    // AuthHandler.hideLoadingSpinner()

                    // Display the form if we have a valid reset code.
                    // AuthHandler.showPasswordResetForm()
                    let resetbutton = document.querySelector("#reset-button");

                    resetbutton.addEventListener('click', e => {
                        AuthHandler.conf.passwordField.setAttribute(
                            'type',
                            AuthHandler.conf.passwordField.getAttribute('type') === 'password'
                                ? 'text' : 'password');
                        e.target.classList.toggle('bi-eye');
                    });

                    resetbutton.addEventListener('click', () => {
                        // AuthHandler.hideMessages()

                        // Test the password again. If it does not pass, errors will display.

                        // Attempt to reset the password.
                        AuthHandler.conf.confirmPasswordReset(
                            AuthHandler.conf.auth,
                            AuthHandler.conf.oobCode,
                            AuthHandler.conf.passwordField.value.trim()
                        ).then(() => {
                            console.log('reseted')
                            // AuthHandler.hidePasswordResetForm()
                            // AuthHandler.hideLoadingSpinner()
                            // AuthHandler.displaySuccessMessage('Password has been reset!')
                        }).catch((e) => {
                            console.log(e)
                            // AuthHandler.hideLoadingSpinner()
                            // AuthHandler.displayErrorMessage('Password reset failed. Please try again.')
                        })

                    });
                }).catch(() => {
                    // AuthHandler.hideLoadingSpinner()
                    // AuthHandler.hidePasswordResetForm()
                    // AuthHandler.displayErrorMessage('Invalid password reset code. Please try again.')
                });
            },
            handleRecoverEmail: () => {
                // AuthHandler.showLoadingSpinner()

                let restoredEmail = null;

                AuthHandler.conf.checkActionCode(AuthHandler.conf.auth, AuthHandler.conf.oobCode).then(info => {
                    restoredEmail = info['data']['email'];
                    AuthHandler.conf.applyActionCode(AuthHandler.conf.auth, AuthHandler.conf.oobCode).then(() => {
                        AuthHandler.conf.sendPasswordResetEmail(AuthHandler.conf.auth, restoredEmail).then(() => {
                            AuthHandler.hideLoadingSpinner()
                            AuthHandler.displaySuccessMessage(`Your email has been restored and a reset password email has been sent to ${restoredEmail}. For security, please reset your password immediately.`)
                        }).catch(() => {
                            AuthHandler.hideLoadingSpinner()
                            AuthHandler.displaySuccessMessage(`Your email ${restoredEmail} has been restored. For security, please reset your password immediately.`)
                        })
                    }).catch(() => {
                        AuthHandler.hideLoadingSpinner()
                        AuthHandler.displayErrorMessage('Sorry, something went wrong recovering your email. Please try again or contact support.')
                    })
                }).catch(() => {
                    AuthHandler.hideLoadingSpinner()
                    AuthHandler.displayErrorMessage('Invalid action code. Please try again.')
                })
            },
            handleVerifyEmail: () => {
                // AuthHandler.showLoadingSpinner()
                AuthHandler.conf.applyActionCode(AuthHandler.conf.auth, 'su_znMay0gSYE8GZ8XwIcJr5bENlJGyffiR9d4emGrIAAAGOfoGgVQ').then(() => {
                    // AuthHandler.hideLoadingSpinner()
                    // AuthHandler.displaySuccessMessage('Email verified! Your account is now active. Time to send some messages!')
                }).catch((e) => {
                    console.log(e)
                    // AuthHandler.hideLoadingSpinner()
                    // AuthHandler.displayErrorMessage('Your code is invalid or has expired. Please try to verify your email address again by tapping the resend email button in app.')
                })
            },
            validateRequiredAuthParams: () => {
                // Mode is evaluated in the bindMode switch. If no mode will display default error message. So, we're just
                // checking for a valid oobCode here.
                return !!AuthHandler.conf.oobCode
            },
            setModeTitle: title => {
                AuthHandler.conf.modeTitle.innerText = title
            },
            validatePasswordComplexity: e => {
                const password = !!e.target ? e.target.value.trim() : e.value.trim()
                const isValidString = typeof password === 'string'

                /// Checks if password has minLength
                const hasMinLength = isValidString && password.length >= 8
                AuthHandler.conf.passwordHasMinLength.style.display = hasMinLength ? 'none' : ''

                /// Checks if password has at least 1 normal char letter matches
                const hasMinNormalChar = isValidString && password.toUpperCase().match(RegExp('^(.*?[A-Z]){1,}')) !== null
                AuthHandler.conf.passwordHasMinNormalChar.style.display = hasMinNormalChar ? 'none' : ''

                /// Checks if password has at least 1 uppercase letter matches
                const hasMinUppercase =
                    isValidString && password.match(RegExp('^(.*?[A-Z]){1,}')) !== null
                AuthHandler.conf.passwordHasMinUppercase.style.display = hasMinUppercase ? 'none' : ''

                /// Checks if password has at least 1 numeric character matches
                const hasMinNumericChar =
                    isValidString && password.match(RegExp('^(.*?[0-9]){1,}')) !== null
                AuthHandler.conf.passwordHasMinNumericChar.style.display = hasMinNumericChar ? 'none' : ''

                /// Checks if password has at least 1 special character matches
                const hasMinSpecialChar = isValidString && password.match(RegExp("^(.*?[\$&+,:;/=?@#|'<>.^*()_%!-]){1,}")) !== null
                AuthHandler.conf.passwordHasMinSpecialChar.style.display = hasMinSpecialChar ? 'none' : ''

                const passing = hasMinLength &&
                    hasMinNormalChar &&
                    hasMinUppercase &&
                    hasMinNumericChar &&
                    hasMinSpecialChar
                AuthHandler.conf.passwordIncreaseComplexity.style.display = passing ? 'none' : ''

                return passing
            },
            // showLoadingSpinner: () => {
            //     AuthHandler.conf.loading.style.display = ''
            // },
            // hideLoadingSpinner: () => {
            //     AuthHandler.conf.loading.style.display = 'none'
            // },
            // showPasswordResetForm: () => {
            //     AuthHandler.conf.passwordForm.style.display = '';
            // },
            // hidePasswordResetForm: () => {
            //     AuthHandler.conf.passwordForm.style.display = 'none';
            // },
            // displaySuccessMessage: message => {
            //     AuthHandler.hideErrorMessage()
            //     AuthHandler.conf.success.innerText = message
            //     AuthHandler.conf.success.style.display = ''
            // },
            // hideSuccessMessage: () => {
            //     AuthHandler.conf.success.innerText = ''
            //     AuthHandler.conf.success.style.display = 'none'
            // },
            // displayErrorMessage: message => {
            //     AuthHandler.hideSuccessMessage()
            //     AuthHandler.conf.error.innerText = message
            //     AuthHandler.conf.error.style.display = ''
            // },
            // hideErrorMessage: () => {
            //     AuthHandler.conf.error.innerText = ''
            //     AuthHandler.conf.error.style.display = 'none'
            // },
            // hideMessages: () => {
            //     AuthHandler.hideErrorMessage()
            //     AuthHandler.hideSuccessMessage()
            // },
        }
    </script>
</head>

<body marginheight="0" topmargin="0" marginwidth="0"
    style="margin: 0px; background-color: #f2f3f8; font-family: 'Poppins', sans-serif;" leftmargin="0">
    <!--100% body table-->
    <table cellspacing="0" border="0" cellpadding="0" width="100%" bgcolor="#f2f3f8"
        style="font-family: 'Poppins', sans-serif;">
        <tr>
            <td>

                <table style="background-color: #f2f3f8; max-width:670px;  margin:0 auto;" width="100%" border="0"
                    align="center" cellpadding="0" cellspacing="0">

                    <tr>
                        <td style="text-align:center; padding-top: 20px;">
                            <a href="#" title="logo" target="_blank">
                                <img width="20%" src="image/Asset 2@4x-8.png" title="logo" alt="logo">
                            </a>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <table width="95%" border="0" align="center" cellpadding="0" cellspacing="0"
                                style="max-width:670px;background:#fff; border-radius:3px; text-align:center;-webkit-box-shadow:0 6px 18px 0 rgba(0,0,0,.06);-moz-box-shadow:0 6px 18px 0 rgba(0,0,0,.06);box-shadow:0 6px 18px 0 rgba(0,0,0,.06);">
                                <tr>
                                    <td style="height:40px;">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td style="padding:0 35px; text-align:left">
                                        <h2 style="color:#1e1e2d; font-weight:500; margin:0;font-size:32px;">Reset
                                            Password</h2>

                                        <p style="color:#53575a; font-size:15px;line-height:24px;">
                                            The password should have at least 6 characters
                                        </p>

                                    </td>

                                </tr>
                                <tr>
                                    <td style="padding:0 35px; text-align:left">
                                        <label for="name" style="color:#1e1e2d; font-weight:500; margin:0;">New
                                            Password</label>

                                </tr>
                                <tr>
                                    <td style="padding:0px 35px; text-align:left; height: 60px; position: relative;">
                                        <div style="position: relative;">
                                            <input type="password" id="password" name="password"
                                                placeholder="Enter Password" minlength="4" maxlength="8" size="10"
                                                style="width: calc(100% - 30px); height: 100%; padding: 15px 40px 15px 15px; box-sizing: border-box;">
                                            <i class="fas fa-eye-slash"
                                                style="position: absolute; left: 90%; top: 50%; transform: translateY(-50%); cursor: pointer;"
                                                onclick="togglePasswordVisibility()"></i>
                                        </div>
                                    </td>
                                </tr>



                                <tr>
                                    <td style="height:10px;">&nbsp;</td> <!-- Reduced the height of the empty row -->
                                </tr>





                                <tr id="reset-button">
                                    <td style="padding:0 35px; text-align:left;" id="reset-button">
                                        <button id="reset-button" onclick="resetPassword()" style="">Reset
                                            Password </button>
                                    </td>
                                </tr>


                                <tr>
                                    <td style="padding:0 35px; text-align:left">
                                        <p style="font-size:15px;line-height:24px;">To make sure your account is secure,
                                            you'll be logged out from other devices once you set the new password</p>

                                    </td>
                                </tr>
                            </table>
                        </td>
                </table>
            </td>
        </tr>
    </table>
    <!--/100% body table-->

    <script type="module">
        function togglePasswordVisibility() {
            var passwordInput = document.getElementById("password");
            var eyeIcon = document.querySelector(".toggle-password");

            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                eyeIcon.classList.remove("fa-eye-slash");
                eyeIcon.classList.add("fa-eye");
            } else {
                passwordInput.type = "password";
                eyeIcon.classList.remove("fa-eye");
                eyeIcon.classList.add("fa-eye-slash");
            }
        }
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import {
            applyActionCode,
            checkActionCode,
            confirmPasswordReset,
            getAuth,
            sendPasswordResetEmail,
            verifyPasswordResetCode,
        } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';

        // Replace {} with your firebaseConfig
        // https://firebase.google.com/docs/web/learn-more#config-object
        const firebaseConfig = {
            apiKey: "AIzaSyA4gFQAuejGyMTdYjCDjD3zvJVKzzAjS7Q",
            authDomain: "stemm-trak.firebaseapp.com",
            projectId: "stemm-trak",
            storageBucket: "stemm-trak.appspot.com",
            messagingSenderId: "46048421418",
            appId: "1:46048421418:web:95ab6dc28b61caed05c553",
            measurementId: "G-B24YLBYWHM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            // Get the mode and oobCode from url params
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });

            AuthHandler.init({
                app,
                auth,
                applyActionCode,
                checkActionCode,
                confirmPasswordReset,
                getAuth,
                sendPasswordResetEmail,
                verifyPasswordResetCode,
                // Used by all modes to display error or success messages
                // error: document.getElementById('error'),
                // success: document.getElementById('success'),
                // https://firebase.google.com/docs/auth/custom-email-handler#create_the_email_action_handler_page
                mode: params.mode,
                oobCode: params.oobCode,
                // modeTitle: document.getElementById('mode-title'),
                // loading: document.getElementById('cover-spin'),
                // Password reset elements
                // passwordForm: document.getElementById('password-form'),
                passwordField: document.getElementById('password'),
                passwordResetButton: document.getElementById('reset-button'),
                // passwordToggleButton: document.getElementById('toggle-password'),
                // passwordHasMinLength: document.getElementById('has-min-length'),
                // passwordHasMinNormalChar: document.getElementById('has-min-normal-char'),
                // passwordHasMinUppercase: document.getElementById('has-min-uppercase'),
                // passwordHasMinNumericChar: document.getElementById('has-min-numeric-char'),
                // passwordHasMinSpecialChar: document.getElementById('has-min-special-char'),
                // passwordIncreaseComplexity: document.getElementById('increase-complexity'),
                defaultErrorMessage: 'Invalid auth parameters. Please try again.',
            });
        });
    </script>




</body>

</html>
